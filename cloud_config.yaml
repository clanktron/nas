#cloud-config
debug: true
hostname: nas
users:
 - name: clayton
   groups:
     - admin
     - docker
   lock_passwd: true
   shell: /usr/bin/fish
   ssh_authorized_keys:
     - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIDOTdQLlqHFSdRU4iYNTx4Dgl+BUKnmSeV1od4BCvot0 clayton@ClaytonsMacBookPro.socal.rr.com
     - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIG/1VzaIV0bnoIv//1FtbRSnwv5KE7KP/sgljykiqTLa mini
     - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIOz0v4rsoL7f/A118ry+wWPd68pcvhkxrd0ITi8feUKQ mb-air
 - name: test
   groups:
     - admin
     - docker
   lock_passwd: true
   shell: /usr/bin/fish
   ssh_authorized_keys:
     - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIDOTdQLlqHFSdRU4iYNTx4Dgl+BUKnmSeV1od4BCvot0 clayton@ClaytonsMacBookPro.socal.rr.com
     - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIG/1VzaIV0bnoIv//1FtbRSnwv5KE7KP/sgljykiqTLa mini
     - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIOz0v4rsoL7f/A118ry+wWPd68pcvhkxrd0ITi8feUKQ mb-air
 - name: git
   lock_passwd: true
   shell: /usr/bin/git-shell
   ssh_authorized_keys:
     - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIDOTdQLlqHFSdRU4iYNTx4Dgl+BUKnmSeV1od4BCvot0 clayton@ClaytonsMacBookPro.socal.rr.com
     - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIG/1VzaIV0bnoIv//1FtbRSnwv5KE7KP/sgljykiqTLa mini
     - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIOz0v4rsoL7f/A118ry+wWPd68pcvhkxrd0ITi8feUKQ mb-air
# fail on cloud config errors
strict: false
install:
    ephemeral_mounts:
        - /scratch
    bind_mounts:
        - /var/lib/docker
        - /var/lib/tailscale
    extra-dirs-rootfs:
        - /data
        - /services
        - /scratch
        - /compose
        - /s3
    poweroff: true
    reboot: false
reset:
    poweroff: true
    reboot: true
    reset-persistent: false
    reset-oem: false
      # ephemeral_mounts:
      #     - /scratch
      # bind_mounts:
      #     - /var/lib/docker
      #     - /var/lib/tailscale
      # extra-dirs-rootfs:
      #     - /data
      #     - /services
      #     - /scratch
      #     - /compose
upgrade:
    poweroff: true
    reboot: true
      # bind_mounts:
      #     - /var/lib/docker
      #     - /var/lib/tailscale
      # ephemeral_mounts:
      #     - /scratch
      # extra-dirs-rootfs:
      #     - /data
      #     - /services
      #     - /scratch
      #     - /compose
ssh_pwauth: false
timezone: America/Los_Angeles
stages:
    network:
      - name: "export data drive"
        files:
        - path: /etc/exports
          content: |
                    /data/media/ 100.64.0.0/10(ro,async,no_subtree_check)
          permissions: 0640
          owner: 0
          group: 0
    fs:
      - name: Import ZPool
        commands:
          - zpool import -af
      - name: mount data drive
        commands:
          - mount /dev/disk/by-id/ata-ST12000NM001G-2MV103_ZLW20B65 /data

      # This fails due to clayton user not existing? not sure what thats about
      # - name: clone dotfiles
      #   git:
      #     branch: main
      #     path: /scratch/dotfiles
      #     url: https://github.com/clanktron/dotfiles
      # - name: install dotfiles
      #   commands:
      #     - chown -R clayton:clayton /scratch/dotfiles && su clayton -c "HOME=/home/clayton /scratch/dotfiles/install"
            # - name: ensure clayton
            #   ensure_entities:
            #   -  path: /etc/passwd
            #      entity: |
            #              kind: "user"
            #              username: "clayton"
            #              password: "x"
            #              uid: 0
            #              gid: 0
            #              info: "Foo!"
            #              homedir: "/home/foo"
            #              shell: "/bin/bash" 
            # - name: "connect to tailscale"
            #   commands:
            #     - tailscale up --authkey=$(cat /root/authkey)
